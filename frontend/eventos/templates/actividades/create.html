{% extends 'base/base_dashboard.html' %}
{% load static %}

{% block title %}Nuevo Evento - Dashboard{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'vendor/geoapify/minimal.css' %}">
<style>
    .form-card {
        border: none;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    }
    .form-group label {
        font-weight: 600;
        color: #495057;
        margin-bottom: 0.5rem;
    }
    .required {
        color: #dc3545;
    }
    .form-control:focus {
        border-color: #007bff;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }
    .btn-submit {
        min-width: 150px;
    }
    .preview-card {
        background-color: #f8f9fa;
        border-left: 4px solid #007bff;
    }
    /* Geoapify custom styles */
    .geoapify-autocomplete-input {
        width: 100%;
        padding: 0.375rem 0.75rem;
        font-size: 1rem;
        font-weight: 400;
        line-height: 1.5;
        color: #212529;
        background-color: #fff;
        background-clip: padding-box;
        border: 1px solid #ced4da;
        border-radius: 0.375rem;
        transition: border-color .15s ease-in-out,box-shadow .15s ease-in-out;
    }
    .geoapify-autocomplete-input:focus {
        color: #212529;
        background-color: #fff;
        border-color: #86b7fe;
        outline: 0;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }
    .autocomplete-container {
        position: relative;
    }
</style>
{% endblock %}

{% block dashboard_content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-lg-8 mx-auto">
            <!-- Header -->
            <div class="d-flex align-items-center mb-4">
                <a href="{% url 'eventos:list' %}" class="btn btn-outline-secondary me-3">
                    ‚Üê Volver
                </a>
                <div>
                    <h2>üéØ Nuevo Evento</h2>
                    <p class="text-muted mb-0">Crear una nueva actividad para {{ asociacion.nombre }}</p>
                </div>
            </div>



            <form method="post" id="eventoForm">
                {% csrf_token %}

                <div class="row">
                    <!-- Formulario principal -->
                    <div class="col-md-8">
                        <div class="card form-card">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0">üìù Datos del Evento</h5>
                            </div>
                            <div class="card-body">
                                <!-- Informaci√≥n b√°sica -->
                                <div class="row">
                                    <div class="col-md-8 mb-3">
                                        <label for="{{ form.nombre.id_for_label }}" class="form-label">
                                            {{ form.nombre.label }} <span class="required">*</span>
                                        </label>
                                        {{ form.nombre }}
                                        {% if form.nombre.errors %}
                                            <div class="text-danger small mt-1">{{ form.nombre.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label for="{{ form.responsable.id_for_label }}" class="form-label">
                                            {{ form.responsable.label }} <span class="required">*</span>
                                        </label>
                                        {{ form.responsable }}
                                        {% if form.responsable.errors %}
                                            <div class="text-danger small mt-1">{{ form.responsable.errors.0 }}</div>
                                        {% endif %}
                                        <div class="form-text">Socia responsable del evento</div>
                                    </div>
                                    <div class="col-md-12 mb-3">
                                        <label for="{{ form.proyecto.id_for_label }}" class="form-label">
                                            {{ form.proyecto.label }}
                                        </label>
                                        {{ form.proyecto }}
                                        {% if form.proyecto.errors %}
                                            <div class="text-danger small mt-1">{{ form.proyecto.errors.0 }}</div>
                                        {% endif %}
                                        <div class="form-text">Proyecto al que pertenece este evento (opcional)</div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-12 mb-3">
                                        <label for="{{ form.descripcion.id_for_label }}" class="form-label">
                                            {{ form.descripcion.label }}
                                        </label>
                                        {{ form.descripcion }}
                                        {% if form.descripcion.errors %}
                                            <div class="text-danger small mt-1">{{ form.descripcion.errors.0 }}</div>
                                        {% endif %}
                                        <div class="form-text">Describe brevemente el evento</div>
                                    </div>
                                </div>

                                <!-- Fecha y hora -->
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.fecha_dia.id_for_label }}" class="form-label">
                                            {{ form.fecha_dia.label }} <span class="required">*</span>
                                        </label>
                                        {{ form.fecha_dia }}
                                        {% if form.fecha_dia.errors %}
                                            <div class="text-danger small mt-1">{{ form.fecha_dia.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.hora_inicio.id_for_label }}" class="form-label">
                                            {{ form.hora_inicio.label }} <span class="required">*</span>
                                        </label>
                                        {{ form.hora_inicio }}
                                        {% if form.hora_inicio.errors %}
                                            <div class="text-danger small mt-1">{{ form.hora_inicio.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>

                                <!-- Duraci√≥n -->
                                <div class="row">
                                    <div class="col-md-12 mb-3">
                                        <label class="form-label">Duraci√≥n</label>
                                        <div class="input-group">
                                            {{ form.duracion_cantidad }}
                                            {{ form.duracion_unidad }}
                                        </div>
                                        {% if form.duracion_cantidad.errors %}
                                            <div class="text-danger small mt-1">{{ form.duracion_cantidad.errors.0 }}</div>
                                        {% endif %}
                                        <div class="form-text">Tiempo estimado de duraci√≥n</div>
                                    </div>
                                </div>

                                <!-- Lugar -->
                                <div class="row">
                                    <div class="col-md-12 mb-3">
                                        <label for="{{ form.lugar_nombre.id_for_label }}" class="form-label">
                                            {{ form.lugar_nombre.label }}
                                        </label>
                                        {{ form.lugar_nombre }}
                                        {% if form.lugar_nombre.errors %}
                                            <div class="text-danger small mt-1">{{ form.lugar_nombre.errors.0 }}</div>
                                        {% endif %}
                                        <div class="form-text">Nombre del lugar (ej: Centro C√≠vico, Plaza Mayor)</div>
                                    </div>

                                    <div class="col-md-12 mb-3">
                                        {% if not GEOAPIFY_API_KEY %}
                                        <div class="alert alert-warning py-1 px-2 mb-2">
                                            <small>‚ö†Ô∏è API Key no detectada. Modo manual activo.</small>
                                        </div>
                                        {% endif %}

                                        <label class="form-label">
                                            {{ form.lugar_direccion.label }} {% if GEOAPIFY_API_KEY %}(B√∫squeda Autom√°tica){% endif %}
                                        </label>

                                        {% if GEOAPIFY_API_KEY %}
                                            <div id="autocomplete" class="autocomplete-container" style="min-height: 40px;">
                                                <div class="text-muted p-2 small">
                                                    <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                                                    Cargando buscador...
                                                </div>
                                            </div>

                                            <!-- Campo oculto para guardar la direcci√≥n completa -->
                                            <div id="manual-address-input" class="d-none">
                                                {{ form.lugar_direccion }}
                                            </div>

                                            <!-- Enlace para cambiar a manual -->
                                            <div class="mt-1 text-end">
                                                <a href="#" id="toggle-manual-mode" class="text-decoration-none small text-muted">
                                                    ¬øProblemas? Ingresar direcci√≥n manualmente
                                                </a>
                                            </div>
                                        {% else %}
                                            <!-- Fallback si no hay API Key -->
                                            {{ form.lugar_direccion }}
                                            <div class="form-text text-muted">
                                                <small>Introduce la direcci√≥n manualmente.</small>
                                            </div>
                                        {% endif %}

                                        {% if form.lugar_direccion.errors %}
                                            <div class="text-danger small mt-1">{{ form.lugar_direccion.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>

                                <!-- Observaciones -->
                                <div class="row">
                                    <div class="col-md-12 mb-3">
                                        <label for="{{ form.observaciones.id_for_label }}" class="form-label">
                                            {{ form.observaciones.label }}
                                        </label>
                                        {{ form.observaciones }}
                                        {% if form.observaciones.errors %}
                                            <div class="text-danger small mt-1">{{ form.observaciones.errors.0 }}</div>
                                        {% endif %}
                                        <div class="form-text">Notas adicionales sobre el evento</div>
                                    </div>
                                </div>


                            </div>
                        </div>
                    </div>

                    <!-- Panel lateral -->
                    <div class="col-md-4">
                        <!-- Vista previa -->
                        <div class="card preview-card mb-3">
                            <div class="card-header">
                                <h6 class="mb-0">üëÅÔ∏è Vista Previa</h6>
                            </div>
                            <div class="card-body">
                                <div id="preview-content">
                                    <h6 id="preview-nombre">Nombre del evento</h6>
                                    <p id="preview-fecha" class="text-muted">üìÖ Fecha por definir</p>
                                    <p id="preview-lugar" class="text-muted">üìç Lugar por definir</p>

                                </div>
                            </div>
                        </div>

                        <!-- Consejos -->
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">üí° Consejos</h6>
                            </div>
                            <div class="card-body">
                                <ul class="small text-muted mb-0">
                                    <li>Usa nombres descriptivos y atractivos</li>
                                    <li>Especifica claramente fecha y hora</li>
                                    <li>Incluye direcciones completas</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Botones de acci√≥n -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="d-flex justify-content-between">
                            <a href="{% url 'eventos:list' %}" class="btn btn-outline-secondary">
                                Cancelar
                            </a>
                            <div>
                                <button type="submit" class="btn btn-primary btn-submit me-2">
                                    üíæ Guardar Evento
                                </button>
                                <button type="button" class="btn btn-success" onclick="submitAndContinue()">
                                    üíæ‚ûï Guardar y Crear Otro
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log("Iniciando configuraci√≥n de Geoapify...");

    // --- Configuraci√≥n de Geoapify ---
    const myAPIKey = "{{ GEOAPIFY_API_KEY }}";
    let autocompleteWidget = null; // Variable global para el widget

    const autocompleteContainer = document.getElementById("autocomplete");
    const manualInputContainer = document.getElementById("manual-address-input");
    const toggleManualBtn = document.getElementById("toggle-manual-mode");

    if (autocompleteContainer) {
        // Funci√≥n para activar modo manual
        function enableManualMode(reason) {
            console.warn("Activando modo manual:", reason);
            autocompleteContainer.style.display = 'none';
            if (manualInputContainer) {
                manualInputContainer.classList.remove('d-none');
                manualInputContainer.style.display = 'block'; // Asegurar visibilidad
                const input = manualInputContainer.querySelector('input, textarea');
                if (input) input.focus();
            }
            if (toggleManualBtn) toggleManualBtn.style.display = 'none'; // Ocultar bot√≥n si ya estamos en manual

            // Mostrar aviso solo si hay raz√≥n de error
            if (reason && !document.getElementById('geoapify-error-alert')) {
                const alertDiv = document.createElement('div');
                alertDiv.id = 'geoapify-error-alert';
                alertDiv.className = 'alert alert-warning py-1 px-2 mb-2';
                alertDiv.innerHTML = '<small>‚ö†Ô∏è ' + reason + '</small>';
                if (manualInputContainer && manualInputContainer.parentNode) {
                    manualInputContainer.parentNode.insertBefore(alertDiv, manualInputContainer);
                }
            }
        }

        // Event listener para el bot√≥n manual
        if (toggleManualBtn) {
            toggleManualBtn.addEventListener('click', function(e) {
                e.preventDefault();
                enableManualMode("Modo manual activado por el usuario.");
            });
        }

        // Funci√≥n para cargar script din√°micamente
        function loadScript(url) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = url;
                script.onload = () => {
                    console.log("Script cargado:", url);
                    resolve();
                };
                script.onerror = () => {
                    console.error("Error cargando script:", url);
                    reject(new Error(`Fallo al cargar script: ${url}`));
                };
                document.head.appendChild(script);
            });
        }

        // Inicializaci√≥n as√≠ncrona
        async function initGeoapify() {
            try {
                // Verificar si ya est√° cargado en window
                if (typeof window.autocomplete === 'undefined' || typeof window.autocomplete.GeocoderAutocomplete === 'undefined') {
                    try {
                        console.log("Cargando librer√≠a local...");
                        await loadScript("{% static 'vendor/geoapify/index.min.js' %}");
                    } catch (e) {
                        console.error("Fallo al cargar librer√≠a local", e);
                        throw new Error("No se pudo cargar el archivo local de mapas.");
                    }
                }

                // Buscar la clase en el namespace 'autocomplete' o globalmente
                const GeocoderAutocomplete = window.autocomplete?.GeocoderAutocomplete || window.GeocoderAutocomplete;

                if (typeof GeocoderAutocomplete === 'undefined') {
                    console.error("Contenido de window.autocomplete:", window.autocomplete);
                    throw new Error("La clase GeocoderAutocomplete no est√° definida tras la carga.");
                }

                console.log("Inicializando GeocoderAutocomplete...");
                // Limpiar indicador de carga
                autocompleteContainer.innerHTML = '';

                autocompleteWidget = new GeocoderAutocomplete(
                    autocompleteContainer,
                    myAPIKey,
                    {
                        lang: 'es',
                        placeholder: 'Escribe la direcci√≥n aqu√≠...',
                        skipDetails: false,
                        debounceDelay: 500,
                        filter: {
                            'countrycode': ["{{ GEOAPIFY_COUNTRY_CODE|default:'es' }}"]
                        },
                        bias: {
                            'proximity': {
                                'lon': parseFloat("{{ GEOAPIFY_BIAS_LON|default:'-3.703790' }}".replace(',', '.')),
                                'lat': parseFloat("{{ GEOAPIFY_BIAS_LAT|default:'40.416775' }}".replace(',', '.'))
                            }
                        }
                    }
                );

                const addressInput = document.getElementById("{{ form.lugar_direccion.id_for_label }}");

                autocompleteWidget.on('select', (location) => {
                    console.log("Direcci√≥n seleccionada:", location);
                    if (location) {
                        addressInput.value = location.properties.formatted;
                        // Actualizar vista previa
                        updatePreview();
                    }
                });

                console.log("Geoapify inicializado correctamente");

            } catch (e) {
                enableManualMode("Error: " + e.message);
            }
        }

        // Iniciar proceso
        initGeoapify();
    }

    // Configurar campos de fecha y hora
    const fechaInput = document.getElementById('{{ form.fecha_dia.id_for_label }}');
    if (fechaInput) {
        fechaInput.type = 'date';
        fechaInput.classList.add('form-control');
    }

    const horaInput = document.getElementById('{{ form.hora_inicio.id_for_label }}');
    if (horaInput) {
        horaInput.setAttribute('type', 'time');
        horaInput.setAttribute('step', '300'); // 5 minutos
        horaInput.classList.add('form-control');
    }

    // A√±adir clases CSS a todos los campos del formulario
    const formControls = ['nombre', 'descripcion', 'lugar_nombre', 'lugar_direccion', 'observaciones', 'duracion_cantidad', 'duracion_unidad'];
    formControls.forEach(function(fieldName) {
        const field = document.getElementById('id_' + fieldName);
        if (field) {
            if (fieldName !== 'duracion_unidad') { // Select ya tiene clase
                 field.classList.add('form-control');
            }
            if (fieldName === 'descripcion' || fieldName === 'observaciones') {
                field.rows = 3;
            }
        }
    });

    // --- Autocomplete Lugar Nombre (Backend) ---
    const lugarNombreInput = document.getElementById('id_lugar_nombre');
    const lugarDireccionInput = document.getElementById('id_lugar_direccion');

    if (lugarNombreInput) {
        const datalistId = 'lugares-list';
        let datalist = document.createElement('datalist');
        datalist.id = datalistId;
        document.body.appendChild(datalist);
        lugarNombreInput.setAttribute('list', datalistId);

        lugarNombreInput.addEventListener('input', function() {
            const query = this.value;
            if (query.length < 2) return;

            fetch(`/api/v1/lugares/buscar?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    datalist.innerHTML = '';
                    data.forEach(lugar => {
                        const option = document.createElement('option');
                        option.value = lugar.nombre;
                        datalist.appendChild(option);
                    });

                    // Si hay coincidencia exacta, rellenar direcci√≥n
                    const match = data.find(l => l.nombre.toLowerCase() === query.toLowerCase());
                    if (match) {
                        console.log("Lugar encontrado en BD:", match);
                        if (lugarDireccionInput) {
                            lugarDireccionInput.value = match.direccion;
                        }
                        if (autocompleteWidget) {
                            autocompleteWidget.setValue(match.direccion);
                        }
                        updatePreview();
                    }
                })
                .catch(err => console.error('Error buscando lugares:', err));
        });
    }

    // Vista previa din√°mica
    function updatePreview() {
        const nombre = document.getElementById('id_nombre').value || 'Nombre del evento';
        const fechaDia = document.getElementById('id_fecha_dia').value;
        const horaInicio = document.getElementById('id_hora_inicio').value;
        const lugarNombre = document.getElementById('id_lugar_nombre').value;
        const lugarDireccion = document.getElementById('id_lugar_direccion').value;

        let lugarTexto = 'üìç Lugar por definir';
        if (lugarNombre && lugarDireccion) {
            lugarTexto = 'üìç ' + lugarNombre + ' (' + lugarDireccion + ')';
        } else if (lugarNombre) {
            lugarTexto = 'üìç ' + lugarNombre;
        } else if (lugarDireccion) {
            lugarTexto = 'üìç ' + lugarDireccion;
        }

        document.getElementById('preview-nombre').textContent = nombre;

        if (fechaDia && horaInicio) {
            const fechaObj = new Date(fechaDia + 'T' + horaInicio);
            const fechaFormat = fechaObj.toLocaleDateString('es-ES', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            document.getElementById('preview-fecha').innerHTML = 'üìÖ ' + fechaFormat;
        } else if (fechaDia) {
             const fechaObj = new Date(fechaDia);
             const fechaFormat = fechaObj.toLocaleDateString('es-ES', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            document.getElementById('preview-fecha').innerHTML = 'üìÖ ' + fechaFormat + ' (Hora por definir)';
        } else {
            document.getElementById('preview-fecha').innerHTML = 'üìÖ Fecha por definir';
        }

        document.getElementById('preview-lugar').innerHTML = lugarTexto;
    }

    // Escuchar cambios en los campos para actualizar vista previa
    ['nombre', 'fecha_dia', 'hora_inicio', 'lugar_nombre', 'lugar_direccion'].forEach(function(fieldName) {
        const field = document.getElementById('id_' + fieldName);
        if (field) {
            field.addEventListener('input', updatePreview);
        }
    });

});

function submitAndContinue() {
    const form = document.getElementById('eventoForm');
    const input = document.createElement('input');
    input.type = 'hidden';
    input.name = 'save_and_continue';
    input.value = 'true';
    form.appendChild(input);
    form.submit();
}

// Validaci√≥n del formulario
document.getElementById('eventoForm').addEventListener('submit', function(e) {
    const nombre = document.getElementById('id_nombre').value.trim();
    const fecha = document.getElementById('id_fecha_dia').value;
    const hora = document.getElementById('id_hora_inicio').value;

    if (!nombre) {
        e.preventDefault();
        alert('El nombre del evento es obligatorio');
        document.getElementById('id_nombre').focus();
        return;
    }

    if (!fecha) {
        e.preventDefault();
        alert('La fecha del evento es obligatoria');
        document.getElementById('id_fecha_dia').focus();
        return;
    }

    if (!hora) {
        e.preventDefault();
        alert('La hora de inicio es obligatoria');
        document.getElementById('id_hora_inicio').focus();
        return;
    }
});
</script>
{% endblock %}