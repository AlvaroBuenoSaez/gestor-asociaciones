name: Build macOS Executable

on:
  release:
    types: [published]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    name: Build Executable on macOS
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller

    - name: Create dummy .env for build
      run: |
        echo "SECRET_KEY=build_dummy_key" > frontend/.env
        echo "DEBUG=False" >> frontend/.env
        echo "API_BASE_URL=http://localhost:8000/api/v1" >> frontend/.env

    - name: Collect Static Files
      run: |
        cd frontend
        python manage.py collectstatic --noinput
      env:
        DJANGO_SETTINGS_MODULE: asonet_django.settings

    - name: Build Executable with PyInstaller
      run: |
        cd deployment/mac_exe
        pyinstaller gestor_mac.spec

    - name: Prepare Release Package
      run: |
        mkdir release_dist_mac
        cp deployment/mac_exe/dist/GestorAsociaciones release_dist_mac/
        cp deployment/mac_exe/config.env.template release_dist_mac/
        cp deployment/mac_exe/INSTRUCCIONES.txt release_dist_mac/
        
    - name: Zip Release
      uses: thedoctor0/zip-release@0.7.5
      with:
        type: 'zip'
        filename: 'GestorAsociaciones_Mac.zip'
        directory: 'release_dist_mac'

    - name: Upload Release Asset
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: release_dist_mac/GestorAsociaciones_Mac.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Upload Artifact (Manual Build)
      uses: actions/upload-artifact@v4
      if: github.event_name == 'workflow_dispatch'
      with:
        name: GestorAsociaciones_Mac
        path: release_dist_mac/GestorAsociaciones_Mac.zip

  test-artifact:
    name: Test Mac Artifact
    needs: build
    if: github.event_name == 'workflow_dispatch'
    runs-on: macos-latest
    steps:
      - name: Download Artifact
        uses: actions/download-artifact@v4
        with:
          name: GestorAsociaciones_Mac
          path: test_dist

      - name: Unzip and Setup
        run: |
          cd test_dist
          unzip GestorAsociaciones_Mac.zip
          # Create config.env from template or scratch
          echo "SECRET_KEY=testing_key_mac" > config.env
          echo "DEBUG=False" >> config.env
          echo "API_BASE_URL=http://localhost:8000/api/v1" >> config.env
          chmod +x GestorAsociaciones

      - name: Run and Test Connection
        run: |
          cd test_dist
          # Run in background
          ./GestorAsociaciones &
          PID=$!
          echo "App running with PID $PID"
          
          # Wait for app to initialize (migrations take time)
          echo "Waiting for app to start..."
          sleep 15
          
          # Test connection
          echo "Testing connection to localhost:8000..."
          curl -v http://127.0.0.1:8000 || exit 1
          
          echo "Connection successful!"
          # Kill app
          kill $PID
