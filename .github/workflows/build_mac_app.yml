name: Build macOS Executable

on:
  release:
    types: [published]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    name: Build Executable on macOS
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller

    - name: Create dummy .env for build
      run: |
        echo "SECRET_KEY=build_dummy_key" > frontend/.env
        echo "DEBUG=False" >> frontend/.env
        echo "API_BASE_URL=http://localhost:8000/api/v1" >> frontend/.env

    - name: Collect Static Files
      run: |
        cd frontend
        python manage.py collectstatic --noinput
      env:
        DJANGO_SETTINGS_MODULE: asonet_django.settings

    - name: Build Executable with PyInstaller
      run: |
        cd deployment/mac_exe
        pyinstaller gestor_mac.spec

    - name: Prepare Release Package
      run: |
        mkdir release_dist_mac
        cp deployment/mac_exe/dist/GestorAsociaciones release_dist_mac/
        cp deployment/mac_exe/config.env.template release_dist_mac/
        cp deployment/mac_exe/INSTRUCCIONES.txt release_dist_mac/

    - name: Zip Release
      uses: thedoctor0/zip-release@0.7.5
      with:
        type: 'zip'
        filename: 'GestorAsociaciones_Mac.zip'
        directory: 'release_dist_mac'

    - name: Upload Release Asset
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: release_dist_mac/GestorAsociaciones_Mac.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Upload Artifact (Manual Build)
      uses: actions/upload-artifact@v4
      if: github.event_name == 'workflow_dispatch'
      with:
        name: GestorAsociaciones_Mac
        path: release_dist_mac/GestorAsociaciones_Mac.zip

  test-artifact:
    name: Test Mac Artifact
    needs: build
    if: github.event_name == 'workflow_dispatch'
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Artifact
        uses: actions/download-artifact@v4
        with:
          name: GestorAsociaciones_Mac
          path: test_dist

      - name: Unzip and Setup
        run: |
          cd test_dist
          unzip GestorAsociaciones_Mac.zip
          # Create config.env with DEBUG=True to see errors in logs
          echo "SECRET_KEY=testing_key_mac" > config.env
          echo "DEBUG=True" >> config.env
          echo "API_BASE_URL=http://localhost:8000/api/v1" >> config.env
          echo "ADMIN_USER=admin" >> config.env
          echo "ADMIN_PASS=admin123456" >> config.env
          chmod +x GestorAsociaciones

      - name: Install Test Dependencies
        run: pip install requests

      - name: Run and Test Connection
        run: |
          cd test_dist
          # Run in background, redirecting logs
          ./GestorAsociaciones > app_out.log 2> app_err.log &
          PID=$!
          echo "App running with PID $PID"
          
          # Wait loop
          MAX_RETRIES=20
          COUNT=0
          SUCCESS=0
          
          echo "Waiting for app to start..."
          while [ $COUNT -lt $MAX_RETRIES ]; do
            sleep 3
            # Use curl to get status code. -L follows redirects.
            STATUS=$(curl -s -L -o /dev/null -w "%{http_code}" http://127.0.0.1:8000)
            echo "Attempt $((COUNT+1)): HTTP Status $STATUS"
            
            if [ "$STATUS" == "200" ]; then
              echo "Connection successful!"
              SUCCESS=1
              break
            fi
            
            COUNT=$((COUNT+1))
          done
          
          if [ $SUCCESS -eq 0 ]; then
            echo "::error::Service failed to become healthy."
            echo "=== STDOUT ==="
            tail -n 100 app_out.log
            echo "=== STDERR ==="
            tail -n 100 app_err.log
            
            # Try to get the error page body
            curl -s -L http://127.0.0.1:8000 > last_response_body.html
            
            kill $PID
            exit 1
          fi
          
          # Run Integration Test (Login)
          echo "Running Integration Test..."
          export ADMIN_USER=admin
          export ADMIN_PASS=admin123456
          python ../tests/verify_deployment.py
          TEST_EXIT_CODE=$?
          
          if [ $TEST_EXIT_CODE -ne 0 ]; then
            echo "::error::Integration test failed."
            kill $PID
            exit 1
          fi

          kill $PID

      - name: Upload debug logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: mac-app-debug-logs
          path: |
            test_dist/app_out.log
            test_dist/app_err.log
            test_dist/last_response_body.html