name: Build Windows Executable

on:
  release:
    types: [published]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    name: Build EXE on Windows
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller

    - name: Create dummy .env for build
      run: |
        echo "SECRET_KEY=build_dummy_key" > frontend/.env
        echo "DEBUG=False" >> frontend/.env
        echo "API_BASE_URL=http://localhost:8000/api/v1" >> frontend/.env

    - name: Collect Static Files
      run: |
        cd frontend
        python manage.py collectstatic --noinput
      env:
        DJANGO_SETTINGS_MODULE: asonet_django.settings

    - name: Build Executable with PyInstaller
      run: |
        cd deployment/win_exe
        pyinstaller gestor.spec

    - name: Prepare Release Package
      run: |
        mkdir release_dist
        copy deployment/win_exe/dist/GestorAsociaciones.exe release_dist/
        copy deployment/win_exe/config.env.template release_dist/
        copy deployment/win_exe/INSTRUCCIONES.txt release_dist/

    - name: Zip Release
      uses: thedoctor0/zip-release@0.7.5
      with:
        type: 'zip'
        filename: 'GestorAsociaciones_Win64.zip'
        directory: 'release_dist'

    - name: Upload Release Asset
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: release_dist/GestorAsociaciones_Win64.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Upload Artifact (Manual Build)
      uses: actions/upload-artifact@v4
      if: github.event_name == 'workflow_dispatch'
      with:
        name: GestorAsociaciones_Win64
        path: release_dist/GestorAsociaciones_Win64.zip

  test-artifact:
    name: Test Windows Artifact
    needs: build
    if: github.event_name == 'workflow_dispatch'
    runs-on: windows-latest
    steps:
      - name: Download Artifact
        uses: actions/download-artifact@v4
        with:
          name: GestorAsociaciones_Win64
          path: test_dist

      - name: Unzip and Setup
        run: |
          cd test_dist
          Expand-Archive -Path GestorAsociaciones_Win64.zip -DestinationPath .
          # Create config.env with DEBUG=True to see errors in logs
          echo "SECRET_KEY=testing_key_win" > config.env
          echo "DEBUG=True" >> config.env
          echo "API_BASE_URL=http://localhost:8000/api/v1" >> config.env

      - name: Run and Test Connection
        shell: powershell
        run: |
          cd test_dist
          # Start process redirecting stdout/stderr so we can inspect tracebacks
          $out = Join-Path $PWD "app_out.log"
          $err = Join-Path $PWD "app_err.log"
          $process = Start-Process -FilePath ".\GestorAsociaciones.exe" -RedirectStandardOutput $out -RedirectStandardError $err -NoNewWindow -PassThru
          echo "App running with ID $($process.Id)"

          # Wait and poll until service is up (or timeout)
          $ready = $false
          $maxAttempts = 20
          $attempt = 0
          while (-not $ready -and $attempt -lt $maxAttempts) {
            Start-Sleep -Seconds 3
            $attempt++
            try {
              $resp = Invoke-WebRequest -Uri "http://127.0.0.1:8000" -UseBasicParsing -TimeoutSec 5
              if ($resp.StatusCode -eq 200) {
                Write-Host "Connection successful!"
                $ready = $true
                break
              } else {
                Write-Host "HTTP $($resp.StatusCode) on attempt $attempt"
              }
            } catch {
              Write-Host "Attempt $attempt: not ready yet ($_)"
            }
          }

          if (-not $ready) {
            Write-Host "Service did not become healthy. Dumping last lines of logs for debugging..."
            if (Test-Path $out) { Get-Content $out -Tail 200 -ErrorAction SilentlyContinue | Write-Host }
            if (Test-Path $err) { Get-Content $err -Tail 200 -ErrorAction SilentlyContinue | Write-Host }
            # If the server returned a non-200 with body, try to save it (helpful for Django error pages)
            try {
              $resp2 = Invoke-WebRequest -Uri "http://127.0.0.1:8000" -UseBasicParsing -ErrorAction SilentlyContinue
              if ($resp2 -and $resp2.Content) {
                $resp2.Content | Out-File -FilePath "last_response_body.html" -Encoding utf8
                Write-Host "Saved response body to last_response_body.html"
              }
            } catch {}
            # Stop process
            Stop-Process -Id $process.Id -Force -ErrorAction SilentlyContinue
            # Upload logs as failure artifacts
            Write-Host "::error::App failed to become healthy, see app_out.log / app_err.log / last_response_body.html"
            exit 1
          } else {
            # successful: stop app
            Stop-Process -Id $process.Id -Force
          }

      - name: Upload debug logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: windows-exe-debug-logs
          path: |
            test_dist/app_out.log
            test_dist/app_err.log
            test_dist/last_response_body.html